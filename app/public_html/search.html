<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Searchify</title>
	<script src="https://d3js.org/d3.v6.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
	<div>
	</div>
    <div>
        <h1 class="header">Searchify</h1>
        <br>
        <hr class="rounded">
        <br>
        <input class = "search" type="text" placeholder="Search for an artist...">
    </div>
<script>
// D3.js
// let p = d3.select("body").selectAll("p")
// 	.data(dataset) // dataset undefined
// 	.enter()
// 	.append("p")
// 	.text(function(d) {return d;});
// let svg = d3.select("body").append("svg");

let qs = window.location.search;
let urlParams = new URLSearchParams(qs);
let access_token = urlParams.get('code');
let refresh_token = urlParams.get('refresh_token');

console.log("Access Token = " + access_token);
console.log("Refresh Token = " + refresh_token);

if(access_token){
    let search_field = document.querySelector("input");
    search_field.addEventListener("keyup", function(event){
        if (event.keyCode === 13) {
        let search_value = search_field.value;
        event.preventDefault();

        console.log(search_value);        
        let fetchURL = '/search?artist=' + search_value + '&code=' + access_token;
        fetch(fetchURL).then(function (response) {
            console.log(response.status);
            if (response.status === 200){
                return response.json();
            } 
            else{
                console.log("error");
            }
        }).then(function (response) {
            console.log(response);
            console.log(response.status);

            // Local Storage -> used in results page
            localStorage.setItem("artist", response.name);
            localStorage.setItem("followers", response.followers);
            localStorage.setItem("genre", response.genre);
            localStorage.setItem("uri", response.uri);
            localStorage.setItem("image", response.imageURL);

            // Redirect
            window.location.replace("http://localhost:3000/result.html");

        }).catch(function (error) {
            console.log(error);
        });
        }   
    });
} 
</script>
</body>
</html>
